<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reversal Task</title>
    
    <!-- jsPsych Core Files -->
    <script src="https://yibei1119.github.io/relmed_task_battery/core/jspsych/jspsych.js"></script>
    <script src="https://yibei1119.github.io/relmed_task_battery/core/jspsych/plugin-html-keyboard-response.js"></script>
    <script src="https://yibei1119.github.io/relmed_task_battery/core/jspsych/plugin-html-button-response.js"></script>
    <script src="https://yibei1119.github.io/relmed_task_battery/core/jspsych/plugin-fullscreen.js"></script>
    <script src="https://yibei1119.github.io/relmed_task_battery/core/jspsych/plugin-instructions.js"></script>
    <script src="https://yibei1119.github.io/relmed_task_battery/core/jspsych/plugin-preload.js"></script>

    <!-- Task-specific files -->
    <script src="https://yibei1119.github.io/relmed_task_battery/tasks/reversal/plugin-reversal.js"></script>

    <!-- Core utilities -->
    <script type="module" src="https://yibei1119.github.io/relmed_task_battery/core/utils/index.js"></script>
    
    <!-- CSS Styles -->
    <link href="https://yibei1119.github.io/relmed_task_battery/core/jspsych/jspsych.css" rel="stylesheet" type="text/css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        #display_element {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .instructions p {
            width: 700px;
            text-align: left;
            margin: 1em 0;
        }
    </style>
</head>
<body>
    <div id="display_element"></div>
    
    <script type="module">
        // Import task registry functions
        import { createTaskTimeline, getTaskInfo } from '/api/index.js';
        import { enterExperiment } from '/core/utils/index.js';

        // Get parameters from URL
        window.participantID = new URLSearchParams(window.location.search).get('participant_id') || '';
        window.simulating = window.participantID.includes("simulate") || false;

        // Initialize jsPsych
        window.jsPsych = initJsPsych({
            display_element: 'display_element',
            on_finish: function(data) {
                // Display results
                jsPsych.getDisplayElement().innerHTML = '<p>Experiment complete. Thank you for participating!</p>';
                console.log('Experiment data:', data.values());
            }
        });


        // Function to run the experiment
        async function runExperiment() {
            try {
                console.log('Starting reversal task...');
                
                // Get task information
                const taskInfo = getTaskInfo('reversal');
                console.log('Task info:', taskInfo);
                
                // Create the task timeline with default settings
                const timeline = await createTaskTimeline('reversal', {sequence: "wk0"});
                console.log('Timeline created:', timeline);
                
                const exitFullscreen = {
                    type: jsPsychFullscreen,
                    fullscreen_mode: false
                };
                
                // Create the complete timeline
                const fullTimeline = [
                    enterExperiment,
                    ...timeline,
                    exitFullscreen
                ];
                
                // Run the experiment
                if (window.simulating) {
                    console.log('Simulating experiment run...');
                    
                    // Simulation options
                    let simulation_options = {
                            default: {
                                data: {
                                rt: 200
                                }
                            }
                    }

                    await jsPsych.simulate(fullTimeline, "visual", simulation_options);
                } else {
                    console.log('Running experiment...');
                    await jsPsych.run(fullTimeline);
                }
                
            } catch (error) {
                console.error('Error running experiment:', error);
                jsPsych.getDisplayElement().innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h2>Error Loading Experiment</h2>
                        <p>There was an error loading the reversal task:</p>
                        <p><strong>${error.message}</strong></p>
                        <p>Please check the console for more details.</p>
                    </div>
                `;
            }
        }

        // Start the experiment when the page loads
        window.addEventListener('load', runExperiment);
    </script>
</body>
</html>
