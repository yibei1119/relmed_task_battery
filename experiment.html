<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study</title>

    <script type="importmap">
        {
            "imports": {
                "@utils/": "./core/utils/",
                "@jspsych/": "./core/jspsych/",
                "@tasks/": "./tasks/",
                "@api/": "./api/",
                "@images/": "./assets/images/"
            }
        }
    </script>
    
    <!-- jsPsych Core Files -->
    <script src="core/jspsych/jspsych.js"></script>
    <script src="core/jspsych/plugin-html-keyboard-response.js"></script>
    <script src="core/jspsych/plugin-html-button-response.js"></script>
    <script src="core/jspsych/plugin-instructions.js"></script>
    <script src="core/jspsych/plugin-preload.js"></script>
    <script src="core/jspsych/plugin-call-function.js"></script>
    <script src="core/jspsych/plugin-fullscreen.js"></script>
    <script src="core/jspsych/plugin-survey-multi-choice.js"></script>
    <script src="core/jspsych/plugin-survey-likert.js"></script>

    
    <!-- Task-specific files -->
    <script src="tasks/card-choosing/plugin-card-choosing.js"></script>
    <script src="tasks/control/plugins/plugin-explore-ship.js"></script>
    <script src="tasks/control/plugins/plugin-explore-ship-feedback.js"></script>
    <script src="tasks/control/plugins/plugin-predict-home-base.js"></script>
    <script src="tasks/control/plugins/plugin-reward-ship.js"></script>
    <script src="tasks/control/plugins/plugin-reward-prompt.js"></script>
    <script src="tasks/reversal/plugin-reversal.js"></script>
    <script src="tasks/open-text/plugin-open-text.js"></script>

    
    <!-- Core utilities -->
    <script type="module" src="core/utils/index.js"></script>

    <!-- CSS Styles -->
    <link href="core/jspsych/jspsych.css" rel="stylesheet" type="text/css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        #display_element {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .instructions p {
            width: 700px;
            text-align: left;
            margin: 1em 0;
        }
    </style>
</head>
<body>
    <div id="display_element"></div>
    
    <script type="module">
        // Import task registry functions
        import { createModuleTimeline, getModuleInfo } from '@api/index.js';
        import { enterExperiment } from '@utils/index.js';

        // Get parameters from URL
        window.participantID = new URLSearchParams(window.location.search).get('participant_id') || '';
        window.simulating = window.participantID.includes("simulate") || false;
        console.log(window.simulating);

        // Initialize jsPsych
        window.jsPsych = initJsPsych({
            display_element: 'display_element',
            on_finish: function(data) {
                // Display results
                jsPsych.getDisplayElement().innerHTML = session == "screening" ? '<p>Thank you for participating! You may now close this tab.</p>' : '<p>Thank you for participating! Please call the experimenter.</p>';
            }
        });

        // Configurations
        const session = new URLSearchParams(window.location.search).get('session') || 'wk0';
        const settings = {
            sequence: session,
            session: session
        };

        // Function to run the experiment
        async function runExperiment() {
            try {
                // Which module to run
                const module_name = session == "screening" ? 'screening' : 'full_battery';

                // Get module information
                const moduleInfo = getModuleInfo(module_name);
                console.log('Module info:', moduleInfo);

                // Create the timeline
                const timeline = await createModuleTimeline(module_name, settings);
                console.log('Timeline created:', timeline);
                
                const exitFullscreen = {
                    type: jsPsychFullscreen,
                    fullscreen_mode: false
                };
                
                // Create the complete timeline
                const fullTimeline = [
                    enterExperiment,
                    ...timeline,
                    exitFullscreen
                ];
                
                // Run the experiment
                if (window.simulating) {
                    console.log('Simulating experiment run...');
                    
                    // Simulation options
                    let simulation_options = {
                            default: {
                                data: {
                                    rt: 200,
                                    speed_up: true,
                                    speed_up_factor: 10,
                                }
                            }
                    }

                    await jsPsych.simulate(fullTimeline, "visual", simulation_options);
                } else {
                    console.log('Running experiment...');
                    await jsPsych.run(fullTimeline);
                }
                
            } catch (error) {
                console.error('Error running experiment:', error);
                jsPsych.getDisplayElement().innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h2>Error Loading Experiment</h2>
                        <p>There was an error loading the card choosing task:</p>
                        <p><strong>${error.message}</strong></p>
                        <p>Please check the console for more details.</p>
                    </div>
                `;
            }
        }

        // Start the experiment when the page loads
        window.addEventListener('load', runExperiment);
    </script>
</body>
</html>
